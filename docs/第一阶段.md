# 第一阶段开发计划

## 目标
完成抖音爬虫核心功能：加密签名、搜索API、BullMQ服务集成

## 任务列表

### 1. 抖音加密模块实现
**目标**：实现抖音API请求所需的 a_bogus 签名参数生成

**实现内容**：
- 从 MediaCrawler 复制 `libs/douyin.js` 签名脚本
- 创建 `src/douyin/signer.ts` 签名模块
- 实现调用 JavaScript 签名函数的接口
- 实现 `get_web_id()` 生成 web_id 参数

**技术方案**：
- 使用 `execjs` 或类似库执行 JavaScript 签名函数
- 暴露 TypeScript 接口供其他模块调用

**输出**：
- `src/douyin/signer.ts`
- `libs/douyin.js` (从 MediaCrawler 复制)

---

### 2. 抖音搜索API封装
**目标**：实现抖音关键字搜索API的请求封装

**实现内容**：
- 创建 `src/douyin/api.ts` API模块
- 实现搜索接口：`/aweme/v1/web/general/search/single/`
- 构造请求参数（使用签名模块）
- 实现HTTP请求（使用 httpx 或 axios）
- 解析搜索结果返回数据

**技术方案**：
- 优先使用纯HTTP请求（Cheerio模式）
- 如需要浏览器环境，集成 Playwright
- 参考 MediaCrawler `client.py` 中的 `search_info_by_keyword` 方法

**API参数**：
- keyword: 搜索关键词
- offset: 偏移量（分页）
- search_channel: 搜索渠道（GENERAL/VIDEO/USER等）
- count: 每页数量（默认15）
- 其他必需参数（aid, version_code, webid, msToken等）

**输出**：
- `src/douyin/api.ts`
- TypeScript 数据模型定义

---

### 3. Vitest 测试（加密 + 搜索API）
**目标**：验证加密签名和搜索API是否正常工作

**测试内容**：
- 测试 a_bogus 签名生成是否正确
- 测试 web_id 生成是否正常
- 测试搜索API请求是否成功
- 验证返回数据结构是否符合预期

**测试用例**：
- 测试用简单的关键词（如"python"）进行搜索
- 验证是否返回视频数据
- 检查响应状态码和错误处理

**输出**：
- `tests/douyin/signer.test.ts`
- `tests/douyin/api.test.ts`
- `vitest.config.ts` 配置文件

---

### 4. 检查其他搜索维度API
**目标**：查看 MediaCrawler 是否支持其他搜索维度，如有则一并实现

**检查内容**：
- 查看 MediaCrawler 搜索API支持哪些 `search_channel` 类型
- 是否支持用户搜索、话题搜索、音乐搜索等
- 如果有，评估是否需要实现

**实现决策**：
- 如有现成代码，参考实现
- 如无现成代码，暂不实现（留待后续扩展）

**可能支持的维度**：
- 视频（VIDEO）- 已实现
- 用户（USER）
- 话题（TOPIC）
- 音乐（MUSIC）

---

### 5. BullMQ 服务实现
**目标**：将爬虫功能包装为 BullMQ 队列服务

**实现内容**：
- 创建 `src/bullmq/queue.ts` 队列模块
- 创建 `src/bullmq/worker.ts` 工作模块
- 定义 Job 数据结构（搜索任务、详情获取等）
- 实现 Job 处理逻辑
- 集成抖音搜索API到 Worker 中

**技术方案**：
- 参考 `./bullmq` 项目文档
- Redis 连接配置
- 基础队列功能（不实现优先级、延迟等复杂功能）

**Job 类型**：
- `search`: 搜索任务（keyword, search_channel等参数）

**输出**：
- `src/bullmq/queue.ts`
- `src/bullmq/worker.ts`
- 服务启动文件 `src/server.ts`

---

### 6. Vitest 测试（BullMQ 服务）
**目标**：验证 BullMQ 服务是否正常运行

**测试内容**：
- 测试队列创建和Job投递
- 测试 Worker 接收和处理 Job
- 测试爬虫任务在 Worker 中的执行
- 验证任务执行结果

**测试用例**：
- 创建搜索 Job 并投递到队列
- 等待 Worker 处理完成
- 验证返回的搜索结果

**输出**：
- `tests/bullmq/queue.test.ts`
- `tests/bullmq/worker.test.ts`

---

## 技术栈

- **语言**: TypeScript
- **签名**: execjs + JavaScript
- **HTTP请求**: httpx 或 axios
- **测试**: vitest
- **队列**: bullmq + ioredis (Redis客户端)
- **运行环境**: Node.js >= 16

## 项目结构规划

```
crawler/
├── src/
│   ├── douyin/
│   │   ├── signer.ts      # 抖音签名模块
│   │   ├── api.ts         # 抖音API封装
│   │   └── types.ts       # 数据类型定义
│   ├── bullmq/
│   │   ├── queue.ts       # 队列定义
│   │   ├── worker.ts      # 工作进程
│   │   └── jobs.ts        # Job类型定义
│   └── server.ts          # 服务启动入口
├── libs/
│   └── douyin.js          # 抖音签名脚本（从MediaCrawler复制）
├── tests/
│   ├── douyin/
│   │   ├── signer.test.ts
│   │   └── api.test.ts
│   └── bullmq/
│       ├── queue.test.ts
│       └── worker.test.ts
├── package.json
├── tsconfig.json
└── vitest.config.ts
```

## 注意事项

1. 本项目仅供学习使用，请遵守相关法律法规
2. 抖音的反爬机制可能随时更新，需要及时维护
3. 测试时请合理控制请求频率，避免对平台造成压力
4. BullMQ 需要 Redis 服务支持，测试时需确保 Redis 可用

## 后续扩展

- [ ] 支持更多社交平台
- [ ] 实现 Crawlee 爬虫框架集成
- [ ] Docker 容器化
- [ ] Kubernetes 部署